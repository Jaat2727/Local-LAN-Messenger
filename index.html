<!doctype html>
<html>
  <head>
    <title>Local-LAN-Messenger</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <meta name="theme-color" content="#111b21" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/app.css" />
  </head>
  <body oncontextmenu="return false;">
    <!-- Animated Gradient Background -->
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <!-- ENHANCED LIGHTBOX -->
    <div id="lightbox">
      <button class="close-btn" onclick="closeLightbox(event)">
        <span class="material-icons">close</span>
      </button>
      <div class="lightbox-counter" id="lightbox-counter">1 / 1</div>
      <button class="lightbox-nav prev" onclick="navigateLightbox(event, -1)">
        <span class="material-icons">chevron_left</span>
      </button>
      <img id="lightbox-img" src="" alt="" onclick="event.stopPropagation()" />
      <button class="lightbox-nav next" onclick="navigateLightbox(event, 1)">
        <span class="material-icons">chevron_right</span>
      </button>
      <div class="lightbox-actions" onclick="event.stopPropagation()">
        <button class="lightbox-action-btn" onclick="openCurrentImage()">
          <span class="material-icons">open_in_new</span>Open
        </button>
        <button class="lightbox-action-btn" onclick="saveCurrentImage()">
          <span class="material-icons">download</span>Save
        </button>
      </div>
    </div>

    <!-- MEDIA GALLERY -->
    <div id="media-gallery">
      <div class="gallery-header">
        <div class="gallery-title">
          <span class="material-icons">photo_library</span>
          Media Gallery
        </div>
        <div class="gallery-controls">
          <button
            class="gallery-filter active"
            data-filter="all"
            onclick="filterGallery('all')"
          >
            All
          </button>
          <button
            class="gallery-filter"
            data-filter="image"
            onclick="filterGallery('image')"
          >
            Images
          </button>
          <button
            class="gallery-filter"
            data-filter="video"
            onclick="filterGallery('video')"
          >
            Videos
          </button>
          <button
            class="header-btn"
            onclick="toggleGallerySort()"
            title="Toggle Sort"
          >
            <span class="material-icons" id="sort-icon">arrow_downward</span>
          </button>
          <button class="header-btn" onclick="closeGallery()">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>
      <div class="storage-stats" id="storage-stats">
        <div class="storage-stats-row">
          <span>Total Files</span>
          <span class="storage-stats-value" id="stats-count">-</span>
        </div>
        <div class="storage-stats-row">
          <span>Storage Used</span>
          <span class="storage-stats-value" id="stats-size">-</span>
        </div>
        <div class="storage-stats-row">
          <span>Orphan Files</span>
          <span class="storage-stats-value" id="stats-orphans">-</span>
        </div>
        <button class="cleanup-btn" onclick="cleanupOrphans()">
          <span
            class="material-icons"
            style="font-size: 16px; vertical-align: middle; margin-right: 6px"
            >delete_sweep</span
          >
          Clean Orphan Files
        </button>
      </div>
      <div class="gallery-content" id="gallery-content">
        <div class="gallery-loading">
          <div class="spinner"></div>
          <div style="margin-top: 16px">Loading media...</div>
        </div>
      </div>
    </div>

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="context-menu"></div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- EDIT MODAL -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <h3>Edit Message</h3>
        <input type="text" id="edit-input" class="modal-input" />
        <div class="modal-btns">
          <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button class="btn-save" onclick="saveEdit()">Save</button>
        </div>
      </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
      <div id="login-box">
        <h2>Chatter FilePro</h2>
        <div class="subtitle">Connect with anyone on your network</div>
        <input
          type="text"
          id="username"
          placeholder="Username"
          autocomplete="off"
        />
        <input type="password" id="password" placeholder="Password" />
        <div id="login-error"></div>
        <button class="login-btn" onclick="login()" id="login-btn">
          <span class="login-text">ENTER CHAT</span>
          <span
            class="login-spinner material-icons"
            style="animation: spin 1s linear infinite"
            >sync</span
          >
        </button>
      </div>
    </div>

    <!-- CHAT CONTAINER -->
    <div id="chat-container">
      <header>
        <div class="header-left">
          <span class="app-title">Chatter</span>
          <span class="online-count" id="online-count">0 online</span>
        </div>
        <div class="header-actions">
          <button
            class="header-btn"
            onclick="toggleSearchPanel()"
            title="Search Messages"
          >
            <span class="material-icons">search</span>
          </button>
          <button
            class="header-btn"
            onclick="toggleOnlinePanel()"
            title="Online Users"
          >
            <span class="material-icons">group</span>
          </button>
          <button
            class="header-btn"
            onclick="openGallery()"
            title="Media Gallery"
          >
            <span class="material-icons">photo_library</span>
          </button>
          <button
            class="header-btn sound-toggle"
            id="sound-toggle-btn"
            onclick="toggleSound()"
            title="Toggle Sound"
          >
            <span class="material-icons">volume_up</span>
          </button>
          <button
            class="header-btn"
            onclick="toggleSelectMode()"
            title="Select Messages"
          >
            <span class="material-icons">checklist</span>
          </button>
        </div>
        <div id="bulkHeader" class="bulk-actions">
          <button class="select-all-btn" onclick="selectAllMessages()">
            Select All
          </button>
          <span id="selectedCount">0 Selected</span>
          <button
            class="header-btn"
            onclick="deleteSelected()"
            style="color: #f15c6d"
          >
            <span class="material-icons">delete</span>
          </button>
          <button class="header-btn" onclick="exitSelectMode()">
            <span class="material-icons">close</span>
          </button>
        </div>
      </header>

      <!-- Online Panel -->
      <div id="online-panel">
        <div class="panel-header">Online Now</div>
        <div class="online-search">
          <input
            type="text"
            class="online-search-input"
            id="online-search-input"
            placeholder="Search users..."
            oninput="filterOnlineUsers(this.value)"
          />
        </div>
        <div class="online-list" id="online-list"></div>
      </div>

      <!-- Search Panel -->
      <div id="search-panel">
        <div class="search-header">
          <span class="material-icons">search</span>
          <input
            type="text"
            id="search-input"
            placeholder="Search messages..."
            oninput="searchMessages(this.value)"
            autocomplete="off"
          />
          <button class="header-btn" onclick="closeSearchPanel()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="search-results" id="search-results">
          <div class="search-empty">Type to search messages...</div>
        </div>
      </div>

      <!-- Incoming Call Modal -->
      <div id="incoming-call-modal" class="call-modal">
        <div class="call-content">
          <div class="call-avatar ringing" id="incoming-call-avatar">?</div>
          <div class="call-name" id="incoming-call-name">Unknown</div>
          <div class="call-status" id="incoming-call-type">
            Incoming voice call...
          </div>

          <!-- Pre-accept controls (shown for video calls) -->
          <div class="pre-accept-controls" id="pre-accept-controls">
            <div class="pre-accept-label">Join with:</div>
            <div class="pre-accept-options">
              <button
                class="pre-accept-btn"
                id="pre-mic-btn"
                onclick="togglePreAcceptMic()"
              >
                <span class="material-icons">mic</span>
                <span class="pre-accept-text">Mic On</span>
              </button>
              <button
                class="pre-accept-btn"
                id="pre-camera-btn"
                onclick="togglePreAcceptCamera()"
              >
                <span class="material-icons">videocam</span>
                <span class="pre-accept-text">Camera On</span>
              </button>
            </div>
          </div>

          <div class="call-actions">
            <button class="call-action-btn call-reject" onclick="rejectCall()">
              <span class="material-icons">call_end</span>
            </button>
            <button class="call-action-btn call-accept" onclick="acceptCall()">
              <span class="material-icons">call</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Outgoing Call Modal -->
      <div id="outgoing-call-modal" class="call-modal">
        <div class="call-content">
          <div class="call-avatar ringing" id="outgoing-call-avatar">?</div>
          <div class="call-name" id="outgoing-call-name">Unknown</div>
          <div class="call-status">Calling...</div>
          <div class="call-actions">
            <button class="call-action-btn call-reject" onclick="cancelCall()">
              <span class="material-icons">call_end</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Active Call Modal - Video Call -->
      <div id="active-call-modal" class="call-modal">
        <!-- Video Call View -->
        <div
          id="video-call-view"
          class="video-call-container"
          style="display: none"
        >
          <!-- Top Controls: Camera flip, Fullscreen, Speaker, Fit, Add Person -->
          <div class="video-call-top-controls">
            <button
              class="video-top-btn"
              id="flip-camera-btn"
              onclick="flipCamera()"
              title="Flip Camera"
              aria-label="Flip camera"
            >
              <span class="material-icons">flip_camera_ios</span>
            </button>
            <button
              class="video-top-btn"
              id="fullscreen-btn"
              onclick="toggleCallFullscreen()"
              title="Fullscreen"
              aria-label="Toggle fullscreen"
            >
              <span class="material-icons">fullscreen</span>
            </button>
            <button
              class="video-top-btn"
              id="fit-video-btn"
              onclick="toggleVideoFit()"
              title="Fit/Fill Screen"
              aria-label="Toggle video fit"
            >
              <span class="material-icons">fit_screen</span>
            </button>
            <button
              class="video-top-btn"
              id="speaker-btn"
              onclick="toggleSpeaker()"
              title="Speaker"
              aria-label="Toggle speaker"
            >
              <span class="material-icons">volume_up</span>
            </button>
            <button
              class="video-top-btn"
              id="add-person-btn"
              onclick="openAddPersonModal()"
              title="Add Person"
              aria-label="Add person to call"
            >
              <span class="material-icons">person_add</span>
            </button>
          </div>

          <div class="video-call-info">
            <div class="video-call-peer" id="video-call-name">Unknown</div>
            <div class="video-call-timer" id="call-timer-video">00:00</div>
          </div>

          <!-- Remote Video (main view) -->
          <video
            id="remote-video"
            class="remote-video"
            autoplay
            playsinline
          ></video>

          <div class="remote-video-status" id="remote-video-status">
            <span class="material-icons">videocam</span>
            <div id="remote-video-status-text">Waiting for video...</div>
          </div>

          <!-- Local Video PiP (tap to expand) -->
          <div
            class="local-video-wrapper"
            id="local-video-wrapper"
            onclick="toggleLocalVideoExpand()"
          >
            <video
              id="local-video"
              class="local-video"
              autoplay
              playsinline
              muted
            ></video>
          </div>

          <!-- Bottom Controls -->
          <div class="video-call-controls">
            <button
              class="call-action-btn call-mute"
              id="mute-btn-video"
              onclick="toggleMute()"
            >
              <span class="material-icons">mic</span>
            </button>
            <button class="call-action-btn call-reject" onclick="endCall()">
              <span class="material-icons">call_end</span>
            </button>
            <button
              class="call-action-btn call-mute"
              id="camera-btn"
              onclick="toggleCamera()"
            >
              <span class="material-icons">videocam</span>
            </button>
          </div>
        </div>

        <!-- Voice Call View -->
        <div
          id="voice-call-view"
          class="voice-call-container"
          style="display: none"
        >
          <div class="call-avatar" id="active-call-avatar">?</div>
          <div class="call-name" id="active-call-name">Unknown</div>
          <div class="call-audio-indicator" id="audio-indicator">
            <div class="call-audio-bar"></div>
            <div class="call-audio-bar"></div>
            <div class="call-audio-bar"></div>
            <div class="call-audio-bar"></div>
            <div class="call-audio-bar"></div>
          </div>
          <div class="call-timer" id="call-timer">00:00</div>
          <div class="call-actions">
            <button
              class="call-action-btn call-mute"
              id="mute-btn"
              onclick="toggleMute()"
            >
              <span class="material-icons">mic</span>
            </button>
            <button class="call-action-btn call-reject" onclick="endCall()">
              <span class="material-icons">call_end</span>
            </button>
          </div>
          <div
            class="call-connecting"
            id="call-connecting"
            style="display: none"
          >
            Connecting...
          </div>
        </div>
      </div>

      <!-- Add Person to Call Modal -->
      <div
        id="add-person-modal"
        class="call-modal"
        style="display: none; background: rgba(0, 0, 0, 0.85)"
      >
        <div class="add-person-content">
          <div class="add-person-header">
            <h3>Add to Call</h3>
            <button onclick="closeAddPersonModal()" class="close-modal-btn">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="add-person-search">
            <input
              type="text"
              id="add-person-search"
              placeholder="Search users..."
              oninput="filterAddPersonList(this.value)"
            />
          </div>
          <div class="add-person-list" id="add-person-list">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Audio element for remote voice call audio -->
      <audio id="remote-audio" autoplay></audio>

      <div id="messages">
        <div class="empty-state" id="empty-state">
          <span class="material-icons">chat_bubble_outline</span>
          <div>No messages yet</div>
          <div style="font-size: 13px; margin-top: 8px">
            Start the conversation!
          </div>
        </div>
      </div>

      <div id="typing-indicator"></div>

      <!-- Reply Bar -->
      <div id="reply-bar">
        <div class="reply-info">
          <div class="reply-user" id="reply-user"></div>
          <div class="reply-text" id="reply-text"></div>
        </div>
        <button class="close-reply" onclick="cancelReply()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <!-- Emoji Picker -->
      <div id="emoji-picker">
        <div class="emoji-grid" id="emoji-grid"></div>
      </div>

      <div id="drop-overlay">
        <span class="material-icons" style="font-size: 48px; margin-right: 12px"
          >cloud_upload</span
        >
        Drop files to upload
      </div>

      <div id="upload-progress">
        <span>Uploading...</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <form class="input-area" onsubmit="sendText(event)">
        <!-- Normal Input State -->
        <div
          id="input-controls"
          style="display: flex; flex: 1; align-items: center; gap: 8px"
        >
          <button type="button" class="icon-btn" onclick="toggleEmojiPicker()">
            <span class="material-icons">emoji_emotions</span>
          </button>
          <button
            type="button"
            class="icon-btn"
            onclick="document.getElementById('fileInput').click()"
          >
            <span class="material-icons">attach_file</span>
          </button>
          <input
            type="file"
            id="fileInput"
            style="display: none"
            multiple
            onchange="uploadFiles(this)"
          />
          <div class="input-wrapper">
            <input
              type="text"
              id="messageInput"
              autocomplete="off"
              placeholder="Type a message..."
            />
          </div>
          <button
            type="button"
            class="icon-btn"
            onclick="startRecording()"
            id="mic-btn"
          >
            <span class="material-icons">mic</span>
          </button>
          <button
            type="submit"
            class="icon-btn send-btn"
            id="send-btn"
            style="display: none"
          >
            <span class="material-icons">send</span>
          </button>
        </div>

        <!-- Recording State -->
        <div
          id="recording-ui"
          style="
            display: none;
            flex: 1;
            align-items: center;
            gap: 12px;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--danger);
            border-radius: 24px;
            padding: 4px 16px;
            height: 50px;
          "
        >
          <button
            type="button"
            class="icon-btn"
            onclick="cancelRecording()"
            style="color: var(--danger)"
          >
            <span class="material-icons">delete</span>
          </button>
          <div
            id="recording-timer"
            style="
              color: var(--danger);
              font-weight: 600;
              min-width: 45px;
              font-variant-numeric: tabular-nums;
            "
          >
            00:00
          </div>
          <canvas
            id="audio-visualizer"
            height="30"
            width="140"
            style="flex: 1"
          ></canvas>
          <button
            type="button"
            class="icon-btn"
            onclick="stopAndSendRecording()"
            style="
              background: var(--primary);
              color: white;
              box-shadow: 0 2px 8px var(--primary-glow);
            "
          >
            <span class="material-icons">send</span>
          </button>
        </div>
      </form>
    </div>

    <script src="/static/js/app.js"></script>
  </body>
</html>
